# 
unless defined? Rails
  $stderr.puts "Run me with script/rails r #$0 < cross_reference_ids.json"
  exit 1
end

panopticon_ids = JSON.parse($stdin.read)

editions_by_panopticon_id = Hash[panopticon_ids.map do |old, new|
  [
    old.to_s, 
    WholeEdition.where(panopticon_id: old.to_i).map(&:id)
  ]
end]

class WholeEdition
  field :old_panopticon_id, :type => Integer
  field :panopticon_id, :type => String
end

# prevent a flood of messages on message queue
WholeEdition.marples_transport = Marples::NullTransport.instance

editions_by_panopticon_id.each do |old_panopticon_id, edition_ids|
  if edition_ids.size == 0
    $stderr.puts "Couldn't find any publication with panopticon_id #{old_panopticon_id}"
    next
  end

  new_panopticon_id = panopticon_ids[old_panopticon_id.to_s]
  puts "Applying mapping #{old_panopticon_id} => #{new_panopticon_id} to #{edition_ids.size} editions"
  edition_ids.each do |edition_id|
    begin
      e = WholeEdition.find(edition_id)
      if e.panopticon_id.to_s != old_panopticon_id 
        raise "Something funny #{edition_id} should have panopticon_id #{old_panopticon_id} but has #{e.panopticon_id}"
      end
      e.old_panopticon_id = old_panopticon_id
      e.panopticon_id = new_panopticon_id
      e.save(validate: false)
      print "."
    rescue => e
      $stderr.puts "Failed to save #{edition_id} because #{e}"
    end
  end

  puts ""
end